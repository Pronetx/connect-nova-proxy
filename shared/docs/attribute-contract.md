# Contact Attribute Contract

**Version:** 1.0
**Last Updated:** 2025-10-25

This document defines the contract between the Voice Gateway and Amazon Connect for contact attributes. Both Dev A and Dev B must adhere to this schema.

## Overview

The Voice Gateway sets contact attributes during and after the Nova conversation. Connect flows read these attributes to make routing decisions.

**Key Constraints:**
- All attribute keys are prefixed with `nova_` to avoid conflicts
- All attribute values must be strings (Connect requirement)
- Total size of all attributes must be < 32KB (Connect limit)
- Attributes are case-sensitive

## Core Attributes (Required)

These attributes MUST be set by the `endCallAndTransfer` tool before hanging up.

### `nova_next`

**Type:** String (enum)
**Required:** Yes
**Set By:** `ConnectEndCallTool` (final call termination)
**Used By:** Connect flow post-transfer routing

**Valid Values:**
- `agent` - Transfer to a human agent queue
- `survey` - Proceed to post-call satisfaction survey
- `end` - End the call (issue resolved or customer requested end)

**Example:**
```json
"nova_next": "agent"
```

**Connect Flow Usage:**
```json
{
  "Type": "CheckAttribute",
  "Attribute": "nova_next",
  "Conditions": [
    {"Value": "agent", "NextAction": "TransferToQueue"},
    {"Value": "survey", "NextAction": "GetCustomerInput"},
    {"Value": "end", "NextAction": "Disconnect"}
  ]
}
```

---

### `nova_summary`

**Type:** String (plain text, max 500 characters)
**Required:** Yes
**Set By:** `ConnectEndCallTool`
**Used By:** Agent screen pop, analytics, quality monitoring

**Purpose:** Human-readable summary of the conversation generated by Nova Sonic.

**Example:**
```json
"nova_summary": "Customer inquired about billing charge $49.99 on account 12345. Explained it was annual subscription renewal. Customer accepted explanation."
```

**Guidelines:**
- Keep under 500 characters for readability
- Use plain language (no technical jargon)
- Include key facts: issue type, account references, outcome
- Avoid PII if possible (use account IDs, not names/SSNs)

---

### `nova_timestamp`

**Type:** String (ISO-8601 format)
**Required:** Yes
**Set By:** `ConnectEndCallTool`
**Used By:** Analytics, audit logging

**Format:** `YYYY-MM-DDTHH:MM:SS.sssZ`

**Example:**
```json
"nova_timestamp": "2025-10-25T14:32:17.324Z"
```

**Implementation:**
```java
String timestamp = Instant.now().toString();
```

---

## Routing Attributes (Conditional)

### `nova_target_queue`

**Type:** String (queue ARN or name)
**Required:** Only if `nova_next=agent`
**Set By:** `ConnectEndCallTool`
**Used By:** Connect "Transfer to queue" block

**Valid Formats:**
- Full ARN: `arn:aws:connect:us-east-1:123456789012:instance/abc-123/queue/def-456`
- Queue name: `BasicQueue` (Connect will resolve to ARN)

**Example:**
```json
"nova_target_queue": "TechnicalSupport"
```

**Connect Flow Usage:**
```json
{
  "Type": "TransferToQueue",
  "QueueId": "$.Attributes.nova_target_queue"
}
```

**Validation:**
- Gateway MUST validate that `nova_target_queue` is set when `nova_next=agent`
- Connect flow SHOULD have fallback queue if attribute missing

---

### `nova_reason`

**Type:** String (enum)
**Required:** No (recommended)
**Set By:** `ConnectEndCallTool`
**Used By:** Analytics, reporting

**Suggested Values:**
- `issue_resolved` - Customer's issue was fully resolved by Nova
- `needs_agent` - Customer explicitly requested human agent
- `needs_escalation` - Issue too complex for Nova
- `customer_hangup` - Customer hung up before resolution
- `technical_issue` - Gateway or Nova encountered an error
- `out_of_scope` - Request outside Nova's capabilities
- `policy_question` - Requires human judgment on policy

**Example:**
```json
"nova_reason": "needs_escalation"
```

---

### `nova_call_duration`

**Type:** String (integer as string, seconds)
**Required:** No (recommended)
**Set By:** `ConnectEndCallTool`
**Used By:** Analytics, billing

**Purpose:** Duration of the Nova conversation portion only (excludes IVR/queue time).

**Example:**
```json
"nova_call_duration": "127"
```

**Implementation:**
```java
long duration = System.currentTimeMillis() - connectContext.getCallStartTime();
String durationSeconds = String.valueOf(duration / 1000);
```

---

## Domain-Specific Attributes (Optional)

These attributes can be set mid-call via `updateContactAttributes` tool to capture business data.

### Customer Identification

```json
"nova_customer_id": "12345",
"nova_account_number": "ACC-98765",
"nova_phone_verified": "true"
```

**Guidelines:**
- Use system IDs, not names/emails (PII concerns)
- Boolean values as strings: `"true"` or `"false"`

---

### Issue Categorization

```json
"nova_issue_type": "billing",
"nova_issue_subtype": "unexpected_charge",
"nova_severity": "medium"
```

**Suggested `nova_issue_type` values:**
- `billing`, `technical`, `account`, `product_info`, `complaint`, `general`

**Suggested `nova_severity` values:**
- `low`, `medium`, `high`, `critical`

---

### Transaction Data

```json
"nova_order_id": "ORD-2024-12345",
"nova_transaction_amount": "49.99",
"nova_payment_method": "visa_1234"
```

**Guidelines:**
- Currency amounts as strings without symbols: `"49.99"` not `"$49.99"`
- Mask sensitive data: `visa_1234` not full card number

---

### Sentiment & Intent

```json
"nova_customer_sentiment": "frustrated",
"nova_intent": "cancel_service",
"nova_satisfaction": "resolved"
```

**Suggested `nova_customer_sentiment` values:**
- `satisfied`, `neutral`, `frustrated`, `angry`, `confused`

**Suggested `nova_intent` values:**
- `get_information`, `resolve_issue`, `make_change`, `cancel_service`, `escalate`

---

## Size Management

**Connect Limit:** 32KB total across all contact attributes (not just `nova_*` keys).

**Best Practices:**
1. **Truncate long values:**
   ```java
   if (summary.length() > 500) {
       summary = summary.substring(0, 497) + "...";
   }
   ```

2. **Prioritize critical attributes:**
   - Always set: `nova_next`, `nova_summary`, `nova_timestamp`
   - Set if applicable: `nova_target_queue`, `nova_reason`
   - Set if space available: domain-specific attributes

3. **Calculate size before update:**
   ```java
   int totalSize = attributes.entrySet().stream()
       .mapToInt(e -> e.getKey().length() + e.getValue().length())
       .sum();
   if (totalSize > 30000) { // Leave 2KB buffer
       // Drop optional attributes or truncate
   }
   ```

---

## Error Handling

### Missing Required Attributes

**Scenario:** `nova_next` not set when call ends

**Connect Flow Handling:**
```json
{
  "Type": "CheckAttribute",
  "Attribute": "nova_next",
  "Conditions": [
    {"Value": "agent", "NextAction": "TransferToQueue"},
    {"Value": "survey", "NextAction": "GetCustomerInput"},
    {"Value": "end", "NextAction": "Disconnect"}
  ],
  "DefaultAction": "TransferToDefaultQueue"  // Fallback
}
```

**Gateway Responsibility:** Always set `nova_next` even on errors. Use `"end"` as safe default.

---

### Connect API Failure

**Scenario:** `UpdateContactAttributes` API call fails (throttling, timeout, etc.)

**Gateway Behavior:**
- Log error with details (status code, error message, contactId)
- Do NOT crash the call or block BYE
- Proceed with call termination
- Set MDC context: `MDC.put("attributeUpdateFailed", "true")`

**Connect Flow Handling:**
- Have fallback routing for missing attributes
- Monitor CloudWatch for API failure rate

---

## Validation Rules

The Gateway MUST validate attributes before calling Connect API:

### Key Validation
```java
// Must start with nova_
if (!key.startsWith("nova_")) {
    throw new IllegalArgumentException("Attribute keys must start with nova_");
}

// Must not be empty
if (key.trim().isEmpty() || value.trim().isEmpty()) {
    throw new IllegalArgumentException("Keys and values cannot be empty");
}
```

### Value Validation
```java
// nova_next enum check
if (key.equals("nova_next")) {
    Set<String> validValues = Set.of("agent", "survey", "end");
    if (!validValues.contains(value)) {
        throw new IllegalArgumentException("Invalid nova_next value: " + value);
    }
}

// nova_target_queue required if nova_next=agent
if (attributes.get("nova_next").equals("agent") &&
    !attributes.containsKey("nova_target_queue")) {
    throw new IllegalArgumentException("nova_target_queue required when nova_next=agent");
}
```

---

## Testing

### Unit Test Checklist

**ConnectAttributeManager:**
- ✅ Sets all required attributes
- ✅ Validates enum values
- ✅ Enforces 32KB limit
- ✅ Handles API failures gracefully
- ✅ Logs all operations

**ConnectEndCallTool:**
- ✅ Requires `nextAction` parameter
- ✅ Requires `targetQueue` when `nextAction=agent`
- ✅ Sets timestamp in ISO-8601 format
- ✅ Calculates call duration correctly
- ✅ Truncates summary at 500 chars

### Integration Test Scenarios

**Test 1: Happy Path - Issue Resolved**
```json
{
  "nova_next": "end",
  "nova_summary": "Customer asked about store hours. Provided information.",
  "nova_reason": "issue_resolved",
  "nova_call_duration": "45",
  "nova_timestamp": "2025-10-25T14:32:17.324Z"
}
```

**Test 2: Agent Transfer**
```json
{
  "nova_next": "agent",
  "nova_target_queue": "BillingSupport",
  "nova_summary": "Customer disputed $99 charge. Requires account review.",
  "nova_reason": "needs_agent",
  "nova_customer_id": "CUST-12345",
  "nova_issue_type": "billing",
  "nova_call_duration": "182",
  "nova_timestamp": "2025-10-25T14:35:22.114Z"
}
```

**Test 3: Mid-Call Updates**
```json
// First update (mid-call)
{
  "nova_customer_id": "CUST-67890",
  "nova_account_number": "ACC-11111"
}

// Second update (mid-call)
{
  "nova_issue_type": "technical",
  "nova_severity": "high"
}

// Final update (end-call)
{
  "nova_next": "agent",
  "nova_target_queue": "TechnicalSupport",
  "nova_summary": "Internet outage reported. Confirmed service issue in area.",
  "nova_reason": "needs_escalation",
  "nova_call_duration": "234",
  "nova_timestamp": "2025-10-25T14:38:45.891Z"
}
```

---

## Example: Complete Attribute Set

```json
{
  // Core (always present)
  "nova_next": "agent",
  "nova_summary": "Customer reported billing issue with $49.99 charge on account ACC-12345. Charge was for annual renewal. Customer wants to discuss cancellation options with billing specialist.",
  "nova_timestamp": "2025-10-25T14:32:17.324Z",

  // Routing (conditional)
  "nova_target_queue": "BillingSupport",
  "nova_reason": "needs_agent",
  "nova_call_duration": "156",

  // Domain-specific (optional)
  "nova_customer_id": "CUST-98765",
  "nova_account_number": "ACC-12345",
  "nova_issue_type": "billing",
  "nova_issue_subtype": "subscription_renewal",
  "nova_severity": "medium",
  "nova_customer_sentiment": "frustrated",
  "nova_intent": "cancel_service",
  "nova_transaction_amount": "49.99"
}
```

**Total Size:** ~700 bytes (well under 32KB limit)

---

## Change Log

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2025-10-25 | Initial contract definition | Claude Code |

---

## Approval

- [ ] Dev A (Voice Gateway) - Reviewed and approved
- [ ] Dev B (Connect Integration) - Reviewed and approved
- [ ] Architect - Reviewed and approved

---

## References

- [Connect UpdateContactAttributes API](https://docs.aws.amazon.com/connect/latest/APIReference/API_UpdateContactAttributes.html)
- [Connect Contact Attributes](https://docs.aws.amazon.com/connect/latest/adminguide/connect-attrib-list.html)
- [Call Flow Sequence Diagram](./call-flow-sequence.md)
